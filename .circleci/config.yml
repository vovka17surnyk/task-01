# Use the latest 2.1 version of CircleCI pipeline process engine.
# See: https://circleci.com/docs/2.0/configuration-reference
version: 2.1


# orbs:
#   slack: circleci/slack@4.3.0

# commands:
#   notify_slack_error:
#     steps:
#       - slack/notify:
#           event: fail
#           template: basic_fail_1


# slack-fail-post-step: &slack-fail-post-step
#   post-steps:
#     - slack/notify:
#         custom: |
#           {
#             "text": "",
#             "blocks": [
#               {
#                 "type": "section",
#                 "text": {
#                   "type": "mrkdwn",
#                   "text": "‚ùå *Failure* #${CIRCLE_BUILD_NUM} `${CIRCLE_PROJECT_REPONAME}` on `${CIRCLE_BRANCH}`"
#                 }
#               },
#               {
#                 "type": "actions",
#                 "elements": [
#                   {
#                     "type": "button",
#                     "text": {
#                       "type": "plain_text",
#                       "text": "View Job"
#                     },
#                     "url": "${CIRCLE_BUILD_URL}"
#                   }
#                 ]
#               }
#             ]
#           }
#         event: fail
# Define a job to be invoked later in a workflow.
# See: https://circleci.com/docs/2.0/configuration-reference/#jobs
jobs:
  test:
    # working_directory: ~/repo
    # Specify the execution environment. You can specify an image from Dockerhub or use one of our Convenience Images from CircleCI's Developer Hub.
    # See: https://circleci.com/docs/2.0/configuration-reference/#docker-machine-macos-windows-executor
    docker:
      - image: circleci/golang:1.15.8
    # Add steps to the job
    # See: https://circleci.com/docs/2.0/configuration-reference/#steps
    steps:
      - checkout
      # - restore_cache:
      #     keys:
      #       - go-mod-v4-{{ checksum "go.sum" }}
      # - run:
      #     name: Install Dependencies
      #     command: go mod download
      # - save_cache:
      #     key: go-mod-v4-{{ checksum "go.sum" }}
      #     paths:
      #       - "/go/pkg/mod"
      - run:
          name: Run tests
          command: |
            gofmt -e main.go
            go build -v ./...
      # - store_test_results:
      #     path: /tmp/test-reports

  build:
    docker:
      - image: docker:stable

    steps:
      # Checkout the repository files
      - checkout

      # Set up a separate Docker environment to run `docker` commands in
      # - setup_remote_docker

      # Build the hello world image
      - run:
          name: Build Docker image and Publish Docker Image to Docker Hub
          command: |
            docker build --tag $DOCKERHUB_REPO . 
            docker login -u "$DOCKERHUB_USERNAME" -p "$DOCKERHUB_PASS" 
            docker push $DOCKERHUB_REPO

# Invoke jobs via workflows
# See: https://circleci.com/docs/2.0/configuration-reference/#workflows
workflows:
  godockerci: # This is the name of the workflow, feel free to change it to better match your workflow.
    # Inside the workflow, you define the jobs you want to run.
    jobs:
      - test:
          filters:
            branches:
              only:
                - main
                - dev
                # - circleci-project-setup
            tags:
              only: \d{1,2}\.\d{1,2}\.\d{1,2}

      - build:
          filters:
            branches:
              only:
                - main
                - dev
                # - circleci-project-setup
            tags:
              only: \d{1,2}\.\d{1,2}\.\d{1,2}
